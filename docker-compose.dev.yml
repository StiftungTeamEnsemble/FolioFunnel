# Development overrides - use with: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

services:
  next-app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      NODE_ENV: development
      # Enable hot reload polling (needed for Docker)
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src
      - ./public:/app/public
      - ./prisma:/app/prisma
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - ./tsconfig.json:/app/tsconfig.json
      - ./next.config.js:/app/next.config.js
      # Persist node_modules in a named volume (don't overwrite with host)
      - app_node_modules:/app/node_modules
    tty: true
    stdin_open: true

  # Separate worker service for development
  worker:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: foliofunnel-worker
    restart: unless-stopped
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://foliofunnel:foliofunnel_secret@postgres:5432/foliofunnel
      DOCUMENT_CONVERTER_API_URL: http://document-converter:8080
      DOCUMENT_CONVERTER_API_KEY: ${DOCUMENT_CONVERTER_API_KEY:-converter_secret_key}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      DATA_DIR: /data
    volumes:
      - ./src:/app/src
      - ./prisma:/app/prisma
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - ./tsconfig.json:/app/tsconfig.json
      - ./data/documents:/data
      # Use separate node_modules volume for worker to avoid Prisma race condition
      - worker_node_modules:/app/node_modules
    command:
      [
        "sh",
        "-c",
        "npx prisma generate && npx prisma migrate deploy && npm run worker",
      ]
    depends_on:
      postgres:
        condition: service_healthy
    tty: true

  prisma-studio:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: foliofunnel-prisma-studio
    restart: unless-stopped
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://foliofunnel:foliofunnel_secret@postgres:5432/foliofunnel
    volumes:
      - ./prisma:/app/prisma
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      # Use separate node_modules volume for Prisma Studio
      - prisma_studio_node_modules:/app/node_modules
    command:
      [
        "sh",
        "-c",
        "npx prisma generate && npx prisma studio --port 5555 --hostname 0.0.0.0",
      ]
    ports:
      - "5555:5555"
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  app_node_modules:
  worker_node_modules:
  prisma_studio_node_modules:
